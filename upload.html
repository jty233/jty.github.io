<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>上传文件</title>

    <link rel="stylesheet" href="style.css">

    <link rel="icon" href="头像.png">
</head>

<body>

    <section>
        <!-- 背景颜色 -->
        <div class="color"></div>
        <div class="color"></div>
        <div class="color"></div>

        <div class="box2"></div>
    </section>



    <div class="text2">
        <h1>上传文件</h1>

        
        <input type="file" id="file" onclick="loadDoc()"><button onclick="loadDoc()">点我上传</button>

        <div id="progress">
            <div class="progress-item"></div>
        </div>
        <span id="time"></span>
        <span id="callback"></span>
    </div>

    <script>
        function loadDoc() {
            var file = document.querySelector("#file").files[0];

            var reader = new FileReader(); //实例化文件读取对象

            reader.readAsDataURL(file); //将文件读取为 DataURL,也就是base64编码
            reader.onload = function (ev) { //文件读取成功完成时触发
                var dataURL = ev.target.result; //获得文件读取成功后的DataURL,也就是base64编码
                // console.log(dataURL);

                dataURL = dataURL.substring(dataURL.indexOf('base64') + 7);

                var obj = {
                    message: '',
                    content: dataURL
                }

                //创建xhr，使用ajax进行文件上传
                var xhr = new XMLHttpRequest();
                var pre = new XMLHttpRequest();
                url = "https://api.github.com/repos/jty233/disk/contents/" + file.name;
                pre.open('GET', url, true);
                pre.send();//第三步：发送请求  将请求参数写在URL中

                var nshow = 0;

                pre.onreadystatechange = function () {
                    if (pre.status == '404' && nshow == 0) {
                        nshow = 1;
                        xhr.open("PUT", url, true);
                        var encode = 'ZTMyODc5MzRjYTM2NDU4NjY2NzAzMTNmZDRlMzFjMmU4MTU4MmE4NQ=='
                        xhr.setRequestHeader('Authorization', 'token ' + window.atob(encode));

                        xhr.upload.onprogress = progressFunction;//【上传进度调用方法实现】

                        xhr.upload.onloadstart = function () {//上传开始执行方法

                            ot = new Date().getTime(); //设置上传开始时间

                            oloaded = 0;//设置上传开始时，以上传的文件大小为0
                        }

                        function progressFunction(evt) {
                            var time = document.getElementById("time");

                            var nt = new Date().getTime();//获取当前时间

                            var pertime = (nt - ot) / 1000; //计算出上次调用该方法时到现在的时间差，单位为s

                            ot = new Date().getTime(); //重新赋值时间，用于下次计算

                            var perload = evt.loaded - oloaded; //计算该分段上传的文件大小，单位b

                            oloaded = evt.loaded;//重新赋值已上传文件大小，用以下次计算

                            //上传速度计算

                            var speed = perload / pertime;//单位b/s

                            var bspeed = speed;

                            var units = 'b/s';//单位名称

                            if (speed / 1024 > 1) {
                                speed = speed / 1024;

                                units = 'k/s';

                            }

                            if (speed / 1024 > 1) {
                                speed = speed / 1024;

                                units = 'M/s';

                            }

                            speed = speed.toFixed(1);

                            //剩余时间

                            var resttime = ((evt.total - evt.loaded) / bspeed).toFixed(1);

                            time.innerHTML = '速度：' + speed + units + '，剩余时间：' + resttime + 's';

                            var percent = event.loaded / event.total * 100;
                            document.querySelector("#progress .progress-item").style.width = percent + "%";

                        }

                        var show = false;
                        xhr.onreadystatechange = function () {//请求后的回调接口，可将请求成功后要执行的程序写在其中                    
                            if (xhr.status == 201 && show == false) {//验证请求是否发送成功
                                alert("已成功上传文件");
                                show = true;
                                document.querySelector("#progress .progress-item").style.width = 0;
                                time.innerHTML = '';
                            }
                            else if (xhr.status != 201 && show == false) {
                                alert("上传失败");
                                show = true;
                                var json = xhr.responseText;//获取到服务端返回的数据
                                console.log(json);
                                document.querySelector("#progress .progress-item").style.width = 0;
                                time.innerHTML = '';
                            }
                        };

                        xhr.send(JSON.stringify(obj))
                    }
                    else if (nshow == 0) {
                        alert("资源已存在");
                        var json = xhr.responseText;//获取到服务端返回的数据
                        console.log(json);
                        nshow = true;
                    }
                };

            }
        }


    </script>

</body>

</html>